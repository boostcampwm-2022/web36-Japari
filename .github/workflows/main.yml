name: 배포

on:
  push:
    branches: [main]

env:
  CLIENT_ENV: ${{ secrets.CLIENT_ENV }}
  SERVER_ENV: ${{ secrets.SERVER_ENV }}

jobs:
  deploy:
    runs-on:
      self-hosted
      # https://docs.github.com/en/actions/hosting-your-own-runners/adding-self-hosted-runners

    steps:
      - name: 체크아웃
        uses: actions/checkout@v3

      - name: client 모듈 설치
        working-directory: ./client
        run: npm install
        
      - name: client 환경변수 파일 생성
        working-directory: ./client
        run: echo $CLIENT_ENV > .env
        
      - name: client 빌드
        working-directory: ./client
        run: |
          npm run build
          rm -rf /var/www/build
          cp -rf ./build /var/www/
      
      - name: server 모듈 설치
        working-directory: ./server
        run: npm install

      - name: server 환경변수 파일 생성
        working-directory: ./server
        run: echo $SERVER_ENV > .env

      - name: pm2 프로세스 재실행
        working-directory: ./server
        run: pm2 restart japari
